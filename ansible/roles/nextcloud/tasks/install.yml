---
# Automated Nextcloud installation tasks using occ commands

- name: Wait for Nextcloud container to be healthy
  shell: docker exec -u www-data nextcloud php -v
  register: nextcloud_health
  retries: 30
  delay: 10
  until: nextcloud_health.rc == 0
  changed_when: false

- name: Wait for Nextcloud auto-installation to complete
  shell: "docker exec -u www-data nextcloud php occ status 2>&1 | grep -q 'installed: true'"
  register: nextcloud_status
  retries: 60
  delay: 5
  until: nextcloud_status.rc == 0
  changed_when: false

- name: Configure trusted domains
  shell: |
    docker exec -u www-data nextcloud php occ config:system:set trusted_domains 0 --value="{{ nextcloud_domain }}"

- name: Configure overwrite settings for reverse proxy
  shell: |
    docker exec -u www-data nextcloud php occ config:system:set overwriteprotocol --value="https"
    docker exec -u www-data nextcloud php occ config:system:set overwritehost --value="{{ nextcloud_domain }}"
    docker exec -u www-data nextcloud php occ config:system:set overwrite.cli.url --value="https://{{ nextcloud_domain }}"
    docker exec -u www-data nextcloud php occ config:system:set trusted_proxies 0 --value="172.18.0.0/16"
    docker exec -u www-data nextcloud php occ config:system:set trusted_proxies 1 --value="172.19.0.0/16"
    docker exec -u www-data nextcloud php occ config:system:set trusted_proxies 2 --value="172.20.0.0/16"
    docker exec -u www-data nextcloud php occ config:system:set trusted_proxies 3 --value="172.21.0.0/16"
    docker exec -u www-data nextcloud php occ config:system:set forwarded_for_headers 0 --value="HTTP_X_FORWARDED_FOR"

- name: Configure Redis for caching
  shell: |
    docker exec -u www-data nextcloud php occ config:system:set redis host --value="{{ nextcloud_redis_host }}"
    docker exec -u www-data nextcloud php occ config:system:set redis port --value="{{ nextcloud_redis_port }}"
    docker exec -u www-data nextcloud php occ config:system:set memcache.local --value="\OC\Memcache\Redis"
    docker exec -u www-data nextcloud php occ config:system:set memcache.locking --value="\OC\Memcache\Redis"

- name: Set default phone region
  shell: |
    docker exec -u www-data nextcloud php occ config:system:set default_phone_region --value="NL"

- name: Run background jobs via cron
  shell: |
    docker exec -u www-data nextcloud php occ background:cron

- name: Add missing database indices
  shell: |
    docker exec -u www-data nextcloud php occ db:add-missing-indices
  register: add_indices
  changed_when: "'Adding' in add_indices.stdout"
  failed_when: false

- name: Run expensive maintenance repairs (mimetype migrations)
  shell: |
    docker exec -u www-data nextcloud php occ maintenance:repair --include-expensive
  register: maintenance_repair
  changed_when: "'mimetype' in maintenance_repair.stdout"
  failed_when: false
  async: 600
  poll: 10

- name: Clear any initial background job errors from log
  shell: |
    docker exec nextcloud truncate -s 0 /var/www/html/data/nextcloud.log
  when: maintenance_repair.changed
  changed_when: false

# Configure admin user email address
- name: Set admin user email address
  shell: |
    docker exec -u www-data nextcloud php occ user:setting {{ nextcloud_admin_user }} settings email "{{ nextcloud_admin_email | default('admin@' + client_domain) }}"
  register: admin_email_result
  changed_when: "'changed' in admin_email_result.stdout or admin_email_result.rc == 0"
  failed_when: false

# Configure system email settings for sending mail
- name: Configure mail sender email address
  shell: |
    docker exec -u www-data nextcloud php occ config:system:set mail_from_address --value="{{ nextcloud_mail_from | default('nextcloud') }}"
    docker exec -u www-data nextcloud php occ config:system:set mail_domain --value="{{ client_domain }}"
  when: smtp_enabled | default(false)

- name: Configure mail mode for SMTP
  shell: |
    docker exec -u www-data nextcloud php occ config:system:set mail_smtpmode --value="smtp"
  when: smtp_enabled | default(false)
